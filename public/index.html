<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>üìä MDB Receiver Dashboard</title>

    <!-- Ic√¥nes -->
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <style>
      body {
        font-family: Arial, sans-serif;
        background: #0e0e0e;
        color: #f0f0f0;
        padding: 20px;
      }
      h1 {
        margin-bottom: 10px;
      }
      .buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      button {
        padding: 10px 20px;
        background: #0078d7;
        border: none;
        color: white;
        cursor: pointer;
        border-radius: 6px;
        font-weight: bold;
        transition: background 0.2s ease;
      }
      button:hover {
        background: #005fa3;
      }
      button.delete {
        background: #c0392b;
      }
      button.delete:hover {
        background: #922b21;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 10px;
        background: #1c1c1c;
        border-radius: 6px;
        overflow: hidden;
      }
      th,
      td {
        border: 1px solid #333;
        padding: 8px;
        text-align: left;
        vertical-align: top;
      }
      th {
        background: #333;
      }
      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        margin: 0;
      }
    </style>
  </head>

  <body>
    <h1>üìä MDB Receiver Dashboard</h1>

    <div class="buttons">
      <button onclick="refreshData()">üîÑ Actualiser les donn√©es</button>
      <button onclick="downloadJSON()">üì• T√©l√©charger JSON</button>
      <button class="delete" onclick="deleteAll()">üóë Supprimer toutes les donn√©es</button>
    </div>

    <table id="dataTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Timestamp</th>
          <th>Device</th>
          <th>Payload</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      // üåê URL de ton serveur Render
      const API_URL = "https://ia-mdb-server.onrender.com";

      // üîÑ R√©cup√©rer les donn√©es et les afficher dans le tableau
      async function refreshData() {
        try {
          const res = await fetch(`${API_URL}/api/mdb/data`);
          const json = await res.json();
          const tableBody = document.querySelector("#dataTable tbody");
          tableBody.innerHTML = "";

          if (!json.data || json.data.length === 0) {
            const row = document.createElement("tr");
            row.innerHTML = `<td colspan="4" style="text-align:center; color:#999;">Aucune donn√©e disponible</td>`;
            tableBody.appendChild(row);
            return;
          }

          json.data.forEach((item, index) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${index + 1}</td>
              <td>${item.timestamp || "‚Äî"}</td>
              <td>${item.deviceInfo?.platform || "‚Äî"}</td>
              <td><pre>${JSON.stringify(item, null, 2)}</pre></td>
            `;
            tableBody.appendChild(row);
          });
        } catch (error) {
          alert("‚ùå Erreur lors du chargement des donn√©es : " + error.message);
        }
      }

      // üì• T√©l√©charger les donn√©es JSON
      async function downloadJSON() {
        try {
          const res = await fetch(`${API_URL}/api/mdb/export`);
          const blob = await res.blob();

          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "mdb_data_export.json";
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
        } catch (error) {
          alert("‚ùå Erreur lors du t√©l√©chargement : " + error.message);
        }
      }

      // üóë Supprimer toutes les donn√©es
      async function deleteAll() {
        if (!confirm("‚ö†Ô∏è Voulez-vous vraiment supprimer toutes les donn√©es ?")) return;
        try {
          const res = await fetch(`${API_URL}/api/mdb/data`, { method: "DELETE" });
          const json = await res.json();
          alert(json.message || "Toutes les donn√©es ont √©t√© supprim√©es");
          refreshData();
        } catch (error) {
          alert("‚ùå Erreur lors de la suppression : " + error.message);
        }
      }

      // üöÄ Chargement initial
      refreshData();
    </script>
  </body>
</html>